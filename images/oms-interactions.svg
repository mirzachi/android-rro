<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1331px" preserveAspectRatio="none" style="width:1442px;height:1331px;background:#FFFFFF;" version="1.1" viewBox="0 0 1442 1331" width="1442px" zoomAndPan="magnify"><defs><filter height="300%" id="fx05mbwt4nsmz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="359" x="538" y="43.3486">Android OverlayManagerService (OMS)</text><rect fill="#FFFFFF" filter="url(#fx05mbwt4nsmz)" height="1164.3125" style="stroke:#000000;stroke-width:2.0;" width="1415" x="10" y="106.8906"/><rect fill="#FFFFFF" height="170.4688" style="stroke:none;stroke-width:1.0;" width="1415" x="10" y="1100.7344"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="50" x2="50" y1="89.8906" y2="1288.2031"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="184" x2="184" y1="89.8906" y2="1288.2031"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="476" x2="476" y1="89.8906" y2="1288.2031"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="676" x2="676" y1="89.8906" y2="1288.2031"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1016" x2="1016" y1="89.8906" y2="1288.2031"/><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="57" x="20" y="54.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="27" y="74.5889">Client</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="57" x="20" y="1287.2031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="27" y="1307.1982">Client</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="182" x="91" y="54.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="168" x="98" y="74.5889">OverlayManagerService</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="182" x="91" y="1287.2031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="168" x="98" y="1307.1982">OverlayManagerService</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="188" x="380" y="54.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="174" x="387" y="74.5889">PackageManagerService</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="188" x="380" y="1287.2031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="174" x="387" y="1307.1982">PackageManagerService</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="184" x="582" y="54.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="170" x="589" y="74.5889">ActivityManagerService</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="184" x="582" y="1287.2031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="170" x="589" y="1307.1982">ActivityManagerService</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="92" x="968" y="54.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="975" y="74.5889">TargetApp</text><rect fill="#FEFECE" filter="url(#fx05mbwt4nsmz)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="92" x="968" y="1287.2031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="975" y="1307.1982">TargetApp</text><path d="M10,106.8906 L76,106.8906 L76,113.8906 L66,123.8906 L10,123.8906 L10,106.8906 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="1164.3125" style="stroke:#000000;stroke-width:2.0;" width="1415" x="10" y="106.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="21" x="25" y="119.9575">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="211" x="91" y="119.1011">[Overlay APK installed disabled]</text><polygon fill="#A80036" points="172,141.1563,182,145.1563,172,149.1563,176,145.1563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="50.5" x2="178" y1="145.1563" y2="145.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="57.5" y="140.0903">setEnabled</text><line style="stroke:#A80036;stroke-width:1.0;" x1="184" x2="226" y1="174.2891" y2="174.2891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="226" x2="226" y1="174.2891" y2="187.2891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="185" x2="226" y1="187.2891" y2="187.2891"/><polygon fill="#A80036" points="195,183.2891,185,187.2891,195,191.2891,191,187.2891" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="191" y="169.2231">handleIncomingUser</text><path d="M189,200.2891 L189,225.2891 L335,225.2891 L335,210.2891 L325,200.2891 L189,200.2891 " fill="#FBFB77" filter="url(#fx05mbwt4nsmz)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M325,200.2891 L325,210.2891 L335,210.2891 L325,200.2891 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="195" y="217.356">Permissions checks</text><line style="stroke:#A80036;stroke-width:1.0;" x1="184" x2="226" y1="255.5547" y2="255.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="226" x2="226" y1="255.5547" y2="268.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="185" x2="226" y1="268.5547" y2="268.5547"/><polygon fill="#A80036" points="195,264.5547,185,268.5547,195,272.5547,191,268.5547" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="191" y="250.4888">enforceActor</text><line style="stroke:#A80036;stroke-width:1.0;" x1="184" x2="226" y1="297.6875" y2="297.6875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="226" x2="226" y1="297.6875" y2="310.6875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="185" x2="226" y1="310.6875" y2="310.6875"/><polygon fill="#A80036" points="195,306.6875,185,310.6875,195,314.6875,191,310.6875" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="191" y="292.6216">updateInternalState</text><polygon fill="#A80036" points="464,335.8203,474,339.8203,464,343.8203,468,339.8203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="184" x2="470" y1="339.8203" y2="339.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="191" y="334.7544">setEnabledOverlayPackages</text><path d="M92,352.8203 L92,422.8203 L568,422.8203 L568,362.8203 L558,352.8203 L92,352.8203 " fill="#FBFB77" filter="url(#fx05mbwt4nsmz)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M558,352.8203 L558,362.8203 L568,362.8203 L558,352.8203 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="202.5" y="369.8872">Updates the target</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="202.5" y="385.02">packages' set of enabled</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="206.5" y="400.1528">overlays in PackageManager</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="238" x="206.5" y="415.2856">(PackageSetting, PackageUserState).</text><polygon fill="#A80036" points="195,449.4844,185,453.4844,195,457.4844,191,453.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="189" x2="475" y1="453.4844" y2="453.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="201" y="448.4185">affectedTargets</text><polygon fill="#A80036" points="664,478.6172,674,482.6172,664,486.6172,668,482.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="184" x2="670" y1="482.6172" y2="482.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="321" x="191" y="477.5513">scheduleApplicationInfoChanged(affectedTargets)</text><path d="M93,495.6172 L93,535.6172 L767,535.6172 L767,505.6172 L757,495.6172 L93,495.6172 " fill="#FBFB77" filter="url(#fx05mbwt4nsmz)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M757,495.6172 L757,505.6172 L767,505.6172 L757,495.6172 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="212" x="292" y="512.6841">Tell the activity manager to tell a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="263" x="292" y="527.8169">set of packages to reload their resources</text><polygon fill="#A80036" points="487,562.0156,477,566.0156,487,570.0156,483,566.0156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="481" x2="675" y1="566.0156" y2="566.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="493" y="560.9497">getApplicationInfo()</text><path d="M338,579.0156 L338,740.0156 L810,740.0156 L810,589.0156 L800,579.0156 L338,579.0156 " fill="#FBFB77" filter="url(#fx05mbwt4nsmz)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M800,579.0156 L800,589.0156 L810,589.0156 L800,579.0156 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="411" x="344" y="596.0825">Information you can retrieve about a particular application.  This</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="440" x="344" y="611.2153">corresponds to information collected from the AndroidManifest.xml's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="348" y="626.3481"/><ellipse cx="349.5" cy="637.0469" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77" x="357" y="641.481">permissions</text><ellipse cx="349.5" cy="652.1797" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="73" x="357" y="656.6138">taskAffinity</text><ellipse cx="349.5" cy="667.3125" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="357" y="671.7466">...</text><ellipse cx="349.5" cy="682.4453" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="360" x="357" y="686.8794">sourceDir - Full path to the base APK for this application.</text><ellipse cx="349.5" cy="697.5781" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="438" x="357" y="702.0122">resourceDirs - Full paths to the locations of extra resource packages</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="344" y="717.145">(runtime overlays) this application uses.</text><ellipse cx="349.5" cy="727.8438" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="357" y="732.2778">...</text><polygon fill="#A80036" points="664,766.4766,674,770.4766,664,774.4766,668,770.4766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="476" x2="670" y1="770.4766" y2="770.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="483" y="765.4106">ApplicationInfo</text><polygon fill="#A80036" points="1004,795.6094,1014,799.6094,1004,803.6094,1008,799.6094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="676" x2="1010" y1="799.6094" y2="799.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="316" x="683" y="794.5435">scheduleApplicationInfoChanged (ApplicationInfo)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1016" x2="1058" y1="828.7422" y2="828.7422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1058" x2="1058" y1="828.7422" y2="841.7422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1017" x2="1058" y1="841.7422" y2="841.7422"/><polygon fill="#A80036" points="1027,837.7422,1017,841.7422,1027,845.7422,1023,841.7422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="1023" y="823.6763">handleApplicationInfoChanged</text><path d="M617,854.7422 L617,1090.7422 L1411,1090.7422 L1411,864.7422 L1401,854.7422 L617,854.7422 " fill="#FBFB77" filter="url(#fx05mbwt4nsmz)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1401,854.7422 L1401,864.7422 L1411,864.7422 L1401,854.7422 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><ellipse cx="628.5" cy="867.375" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328" x="636" y="871.8091">Take the diff of the old ApplicationInfo and the new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="623" y="886.9419">to see if anything needs to change.</text><ellipse cx="628.5" cy="897.6406" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="626" x="636" y="902.0747">Update all affected loaded packages representations (LoadedApk) with new package information.</text><ellipse cx="628.5" cy="912.7734" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="438" x="636" y="917.2075">Create a new ResourcesImpl (point to resources files via new paths)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="627" y="932.3403">* Here is the new AssetManager created with new APKs (list of ApkAssets)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="310" x="627" y="947.4731">* Already loaded APKs are taken from the cache</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="627" y="962.606">* New overlay APKs are loaded from the disk</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="241" x="627" y="977.7388">* Loading happens on the C/C++ side</text><ellipse cx="628.5" cy="988.4375" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="760" x="636" y="992.8716">Update all affected Resources objects to use new ResourcesImpl (ResourcesManager-&gt;applyNewResourceDirsLocked)</text><ellipse cx="628.5" cy="1003.5703" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="636" y="1008.0044">Reset cache.</text><ellipse cx="628.5" cy="1018.7031" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="329" x="636" y="1023.1372">Trigger app framework Configuration change event</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="641" x="623" y="1038.27">(look for resources again using best matching algorithm via new ResourcesImpl (overlays included))</text><ellipse cx="628.5" cy="1048.9688" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="425" x="636" y="1053.4028">Relaunch all activities (now they use new configuration/resources)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="423" x="639" y="1068.5356">* Preserve windows to avoid black flickers when overlays change.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="639" y="1083.6685">* onDestroy followed by onCreate called</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="10" x2="1425" y1="1101.7344" y2="1101.7344"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="236" x="15" y="1111.9448">[Overlay package installed enabled]</text><polygon fill="#A80036" points="195,1132.6719,185,1136.6719,195,1140.6719,191,1136.6719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="189" x2="475" y1="1136.6719" y2="1136.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268" x="201" y="1131.606">Intent.action = ACTION_PACKAGE_ADDED</text><polygon fill="#A80036" points="464,1161.8047,474,1165.8047,464,1169.8047,468,1165.8047" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="184" x2="470" y1="1165.8047" y2="1165.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="191" y="1160.7388">getPackageInfo(packageName)</text><polygon fill="#A80036" points="195,1190.9375,185,1194.9375,195,1198.9375,191,1194.9375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="189" x2="475" y1="1194.9375" y2="1194.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="201" y="1189.8716">PackageInfo</text><polygon fill="#A80036" points="464,1220.0703,474,1224.0703,464,1228.0703,468,1224.0703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="184" x2="470" y1="1224.0703" y2="1224.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="191" y="1219.0044">setEnabledOverlayPackages</text><path d="M116,1237.0703 L116,1262.0703 L1084,1262.0703 L1084,1247.0703 L1074,1237.0703 L116,1237.0703 " fill="#FBFB77" filter="url(#fx05mbwt4nsmz)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1074,1237.0703 L1074,1247.0703 L1084,1247.0703 L1074,1237.0703 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="482" y="1254.1372">From here same process as above</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="84" x="1351" y="14.2822">android-master</text><!--MD5=[c7795c4abc3b1f73811786a3e419bb22]
@startuml
'https://plantuml.com/sequence-diagram

header android-master
title Android OverlayManagerService (OMS)

participant Client as client
participant OverlayManagerService as oms
participant PackageManagerService as pms
participant ActivityManagerService as ams
participant TargetApp as app

alt Overlay APK installed disabled

client -> oms : setEnabled
oms -> oms : handleIncomingUser
note right of oms: Permissions checks
oms -> oms : enforceActor
oms -> oms : updateInternalState

oms -> pms : setEnabledOverlayPackages
note over oms, pms
Updates the target
packages' set of enabled
 overlays in PackageManager
 (PackageSetting, PackageUserState).
end note
oms <- pms : affectedTargets

oms -> ams : scheduleApplicationInfoChanged(affectedTargets)
note over oms, ams
Tell the activity manager to tell a
set of packages to reload their resources
end note
ams -> pms : getApplicationInfo()
note over pms, ams
Information you can retrieve about a particular application.  This
corresponds to information collected from the AndroidManifest.xml's

* permissions
* taskAffinity
* ...
* sourceDir - Full path to the base APK for this application.
* resourceDirs - Full paths to the locations of extra resource packages
(runtime overlays) this application uses.
* ...
end note
pms -> ams : ApplicationInfo
ams -> app : scheduleApplicationInfoChanged (ApplicationInfo)

app -> app : handleApplicationInfoChanged
note over app
* Take the diff of the old ApplicationInfo and the new
to see if anything needs to change.
* Update all affected loaded packages representations (LoadedApk) with new package information.
* Create a new ResourcesImpl (point to resources files via new paths)
 * Here is the new AssetManager created with new APKs (list of ApkAssets)
 * Already loaded APKs are taken from the cache
 * New overlay APKs are loaded from the disk
 * Loading happens on the C/C++ side
* Update all affected Resources objects to use new ResourcesImpl (ResourcesManager->applyNewResourceDirsLocked)
* Reset cache.
* Trigger app framework Configuration change event
(look for resources again using best matching algorithm via new ResourcesImpl (overlays included))
* Relaunch all activities (now they use new configuration/resources)
    * Preserve windows to avoid black flickers when overlays change.
    * onDestroy followed by onCreate called
end note

else Overlay package installed enabled

oms <- pms : Intent.action = ACTION_PACKAGE_ADDED

oms -> pms : getPackageInfo(packageName)

oms <- pms : PackageInfo

oms -> pms : setEnabledOverlayPackages

note over oms, app
From here same process as above
end note
end
@enduml

@startuml

header android-master
title Android OverlayManagerService (OMS)

participant Client as client
participant OverlayManagerService as oms
participant PackageManagerService as pms
participant ActivityManagerService as ams
participant TargetApp as app

alt Overlay APK installed disabled

client -> oms : setEnabled
oms -> oms : handleIncomingUser
note right of oms: Permissions checks
oms -> oms : enforceActor
oms -> oms : updateInternalState

oms -> pms : setEnabledOverlayPackages
note over oms, pms
Updates the target
packages' set of enabled
 overlays in PackageManager
 (PackageSetting, PackageUserState).
end note
oms <- pms : affectedTargets

oms -> ams : scheduleApplicationInfoChanged(affectedTargets)
note over oms, ams
Tell the activity manager to tell a
set of packages to reload their resources
end note
ams -> pms : getApplicationInfo()
note over pms, ams
Information you can retrieve about a particular application.  This
corresponds to information collected from the AndroidManifest.xml's

* permissions
* taskAffinity
* ...
* sourceDir - Full path to the base APK for this application.
* resourceDirs - Full paths to the locations of extra resource packages
(runtime overlays) this application uses.
* ...
end note
pms -> ams : ApplicationInfo
ams -> app : scheduleApplicationInfoChanged (ApplicationInfo)

app -> app : handleApplicationInfoChanged
note over app
* Take the diff of the old ApplicationInfo and the new
to see if anything needs to change.
* Update all affected loaded packages representations (LoadedApk) with new package information.
* Create a new ResourcesImpl (point to resources files via new paths)
 * Here is the new AssetManager created with new APKs (list of ApkAssets)
 * Already loaded APKs are taken from the cache
 * New overlay APKs are loaded from the disk
 * Loading happens on the C/C++ side
* Update all affected Resources objects to use new ResourcesImpl (ResourcesManager->applyNewResourceDirsLocked)
* Reset cache.
* Trigger app framework Configuration change event
(look for resources again using best matching algorithm via new ResourcesImpl (overlays included))
* Relaunch all activities (now they use new configuration/resources)
    * Preserve windows to avoid black flickers when overlays change.
    * onDestroy followed by onCreate called
end note

else Overlay package installed enabled

oms <- pms : Intent.action = ACTION_PACKAGE_ADDED

oms -> pms : getPackageInfo(packageName)

oms <- pms : PackageInfo

oms -> pms : setEnabledOverlayPackages

note over oms, app
From here same process as above
end note
end
@enduml

PlantUML version 1.2021.11beta5(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>